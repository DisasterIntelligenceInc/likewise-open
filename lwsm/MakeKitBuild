SUBDIRS="include common client server"

configure()
{
    mk_config_header "include/config.h"

    MK_CPPFLAGS="$MK_CPPFLAGS -DLWSM_DISABLE_DEPRECATED -DLWSM_BUILD"
    MK_CFLAGS="$MK_CFLAGS -Wall -Werror -Wmissing-prototypes"

    lw_define_feature_macros

    mk_define SBINDIR "\"$MK_SBINDIR\""
    mk_define CACHEDIR "\"$LW_CACHEDIR\""
    mk_define LOADERDIR "\"$MK_LIBDIR/lwsm-loader\""
    mk_define MOD_EXT "\"$MK_DLO_EXT\""

    mk_export MOD_EXT="$MK_DLO_EXT"

    # Check endianness
    mk_check_endian

    # Required headers
    mk_check_headers \
        FAIL=yes \
        lwmsg/lwmsg.h lwadvapi.h lw/base.h

    # Optional headers
    mk_check_headers \
        pthread.h strings.h

    # Required libraries
    mk_check_libraries \
        FAIL=yes \
        lwmsg lwadvapi lwbase regclient lwioclient

    # Optional libraries
    mk_check_libraries \
        pthread dl

    # Check for broken PTHREAD_ONCE_INIT
    if mk_try_compile \
        CODE="pthread_once_t once = PTHREAD_ONCE_INIT; *(&once) = once; return 0;" \
        CFLAGS="-Wall -Werror" \
        HEADERDEPS="pthread.h"
    then
        mk_define BROKEN_ONCE_INIT 0
        mk_msg "broken PTHREAD_ONCE_INIT: no"
    else
        mk_define BROKEN_ONCE_INIT 1
        mk_msg "broken PTHREAD_ONCE_INIT: yes"
    fi
}